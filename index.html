<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Prayers</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzsnkFikMGtsWkFR837c-n15ozxVjAGXk",
            authDomain: "prayer-app-cloud.firebaseapp.com",
            projectId: "prayer-app-cloud",
            storageBucket: "prayer-app-cloud.firebasestorage.app",
            messagingSenderId: "1090528891146",
            appId: "1:1090528891146:web:073dbda89ecd8682736af3",
            measurementId: "G-9NZMGRVZQ8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let cloudDB = { Monday: [], Tuesday: [], Wednesday: [], Thursday: [], Friday: [], Saturday: [], Sunday: [], everyday: [] };
        let userDocRef = null;

        // Connect to the Cloud
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userDocRef = doc(db, "users", user.uid);
                // Listen to cloud changes in real-time
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        cloudDB = docSnap.data();
                        renderPrayers(); 
                        renderSpecialManager();
                    } else {
                        // First time user: upload empty template
                        saveDB(cloudDB);
                    }
                });
            } else {
                signInAnonymously(auth);
            }
        });

        // Globalized functions for your original script to use
        window.getDB = () => cloudDB;
        window.saveDB = async (newData) => {
            if (userDocRef) {
                await setDoc(userDocRef, newData);
            }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Lato:wght@300;400&display=swap');
        
        :root {
            --cream: #faf8f3; --sand: #e8e3d6; --terracotta: #c85a3e;
            --deep-green: #2d4538; --soft-green: #546b5a; --gold: #b8925a;
            --shadow: rgba(45, 69, 56, 0.1);
            --bg-gradient: linear-gradient(135deg, #faf8f3 0%, #e8e3d6 100%);
            --card-bg: white; --text-color: #2d4538;
        }

        [data-theme="dark"] {
            --cream: #1a1c1b; --sand: #2d2f2e; --terracotta: #e07a5f;
            --deep-green: #e8e3d6; --soft-green: #a8b0ab; --gold: #d4af37;
            --shadow: rgba(0, 0, 0, 0.4);
            --bg-gradient: linear-gradient(135deg, #121413 0%, #1a1c1b 100%);
            --card-bg: #242625; --text-color: #f4f1ea;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'Lato', sans-serif; background: var(--bg-gradient); min-height: 100vh; color: var(--text-color); padding-bottom: 80px; }
        
        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--bg-gradient);
            z-index: 100;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid transparent;
            transition: box-shadow 0.3s;
        }
        
        .sticky-header.scrolled {
            box-shadow: 0 4px 15px var(--shadow);
            border-bottom: 1px solid var(--sand);
        }

        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; }
        
        header { text-align: center; margin-bottom: 15px; width: 100%; }
        h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.2rem; font-weight: 300; color: var(--deep-green); letter-spacing: 2px; }

        .main-layout { display: flex; gap: 20px; align-items: flex-start; padding: 0 20px; }
        .left-column { flex: 2; min-width: 0; }
        .right-column { flex: 1; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 180px; }

        .theme-toggle-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .theme-toggle { background: var(--deep-green); color: white; border: none; padding: 10px 15px; border-radius: 30px; cursor: pointer; font-size: 0.75rem; box-shadow: 0 4px 10px var(--shadow); }
        
        .day-selector { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; max-width: 900px; margin: 0 auto 10px auto; }
        .day-btn { background: var(--card-bg); border: 2px solid var(--sand); padding: 12px 2px; border-radius: 12px; font-family: 'Cormorant Garamond', serif; font-size: 1rem; cursor: pointer; color: var(--soft-green); transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: clip; }
        .day-btn.active { background: var(--gold); color: white; border-color: var(--gold); }
        
        .nav-btn { width: 100%; padding: 14px; border-radius: 10px; font-family: 'Lato', sans-serif; font-size: 0.9rem; cursor: pointer; border: none; transition: 0.2s; text-align: center; }
        .mode-btn { background: var(--card-bg); border: 2px solid var(--sand); color: var(--soft-green); }
        .mode-btn.active { background: var(--terracotta); color: white; border-color: var(--terracotta); }
        .special-btn { background: var(--soft-green); color: white; }
        .save-btn { background: var(--gold); color: white; font-weight: bold; }
        .cancel-btn { background: var(--card-bg); border: 2px solid var(--sand); color: var(--terracotta); }

        .content-section { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px var(--shadow); margin-bottom: 20px; }
        
        #dayPicker { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 15px 0; }
        .picker-day { padding: 10px; background: var(--cream); border-radius: 8px; text-align: center; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--sand); transition: 0.2s; }
        .picker-day.selected { background: var(--terracotta); color: white; border-color: var(--terracotta); }

        .prayer-item { background: var(--cream); padding: 15px; border-radius: 12px; border-left: 4px solid var(--gold); margin-bottom: 12px; }
        .prayer-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .prayer-text { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; line-height: 1.3; flex-grow: 1; }
        .prayer-actions { display: flex; align-items: center; gap: 15px; margin-left: 10px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--text-color); opacity: 0.7; }

        .sub-list { margin-top: 10px; padding-left: 15px; border-top: 1px solid var(--sand); padding-top: 10px; }
        .sub-item { display: flex; align-items: center; font-size: 1rem; padding: 6px 0; color: var(--soft-green); position: relative; }
        .sub-text { flex-grow: 1; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; }
        .sub-delete { margin-left: 40px; font-size: 0.9rem; color: var(--terracotta); opacity: 0.5; }

        textarea { width: 100%; padding: 15px; border: 2px solid var(--sand); border-radius: 10px; font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; min-height: 120px; background: var(--cream); color: var(--text-color); margin-bottom: 10px; outline: none; }
        
        .modal-input { width: 100%; padding: 12px; border: 2px solid var(--sand); border-radius: 8px; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; background: var(--cream); color: var(--text-color); margin-bottom: 15px; outline: none; }

        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: var(--card-bg); padding: 30px; border-radius: 20px; max-width: 90%; width: 420px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal h3 { font-family: 'Cormorant Garamond', serif; margin-bottom: 20px; font-size: 1.4rem; font-weight: 400; line-height: 1.4; }
        .modal-buttons { display: flex; flex-direction: column; gap: 12px; }
        .modal-btn { padding: 14px; border-radius: 12px; border: none; cursor: pointer; font-family: 'Lato', sans-serif; font-weight: bold; transition: 0.2s; }

        .sync-section { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; padding: 15px; border-top: 1px dashed var(--sand); text-align: center; }
        .sync-btn { background: transparent; color: var(--soft-green); border: 1px solid var(--soft-green); padding: 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        @media (max-width: 768px) {
            .main-layout { flex-direction: column; padding: 0 15px; }
            .right-column { order: -1; flex-direction: row; flex-wrap: wrap; position: static; margin-bottom: 20px; }
            .nav-btn { flex: 1 1 45%; font-size: 0.8rem; padding: 10px; }
            .day-selector { grid-template-columns: repeat(4, 1fr); }
            .day-btn { font-size: 0.85rem; }
            .sticky-header { padding: 10px 15px 5px 15px; }
        }
    </style>
</head>
<body>
    <div class="sticky-header" id="headerNav">
        <div class="container">
            <header><h1>Daily Prayers</h1></header>
            <div class="day-selector" id="mainDaySelector"></div>
        </div>
    </div>

    <div class="container">
        <div class="main-layout">
            <div class="left-column">
                <div class="content-section" id="viewSection"><div id="prayerList"></div></div>
                <div class="content-section" id="addSection" style="display: none;">
                    <h3 id="addTitle">Add Prayer</h3>
                    <div id="dayPicker" style="display:none;"></div>
                    <textarea id="prayerInput" placeholder="Write your prayer here..."></textarea>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="nav-btn save-btn" id="dynamicAddBtn" onclick="saveNewPrayer()">Save Prayer</button>
                        <button class="nav-btn cancel-btn" onclick="showView()">Cancel</button>
                    </div>
                    <div id="specialManagerArea" style="display:none;">
                        <div class="manager-title" style="margin-top:20px; font-size:0.8rem; font-weight:bold; color:var(--gold); border-top:1px solid var(--sand); padding-top:10px; margin-bottom:10px;">Manage Special Group Prayers</div>
                        <div id="specialItemsList"></div>
                    </div>
                </div>
                <div class="sync-section">
                    <p style="font-size: 0.7rem; color: var(--gold); margin-bottom: 5px;">Cloud Sync Active</p>
                    <button class="sync-btn" onclick="confirmExport()">Backup to File</button>
                    <button class="sync-btn" onclick="document.getElementById('importFile').click()">Restore from File</button>
                    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
                </div>
            </div>
            <div class="right-column">
                <button class="nav-btn mode-btn active" id="viewModeBtn" onclick="showView()">View Prayers</button>
                <button class="nav-btn mode-btn" id="addModeBtn" onclick="openAddMode('day')">Add Prayer for...</button>
                <button class="nav-btn special-btn" onclick="openAddMode('everyday')">+ Everyday Prayers</button>
                <button class="nav-btn special-btn" onclick="openAddMode('special')">+ Special Prayers</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h3 id="modalMsg"></h3>
            <div id="modalInputContainer"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">Dark Mode</button>
    </div>

    <script>
        let currentDay = '';
        let selectedCategory = 'day';
        let multiSelectedDays = [];
        let editingGroupId = null;
        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        window.addEventListener('scroll', () => {
            const header = document.getElementById('headerNav');
            if (window.scrollY > 20) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // REPLACED: These now bridge to the Firebase Script at the top
        // getDB() and saveDB() are now defined in the Firebase <script> block

        function showModal(msg, buttons, showInput = false) {
            const overlay = document.getElementById('modalOverlay');
            const container = document.getElementById('modalButtons');
            const inputContainer = document.getElementById('modalInputContainer');
            document.getElementById('modalMsg').innerText = msg;
            inputContainer.innerHTML = showInput ? `<input type="text" id="modalField" class="modal-input" placeholder="Type here..." autocomplete="off">` : '';
            container.innerHTML = '';
            buttons.forEach(b => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn';
                btn.style.background = b.bg || 'var(--sand)';
                btn.style.color = b.color || 'var(--text-color)';
                btn.innerText = b.text;
                btn.onclick = () => { 
                    const val = showInput ? document.getElementById('modalField').value.trim() : null;
                    if(showInput && !val && !b.isCancel) return; 
                    overlay.style.display = 'none'; 
                    b.action(val); 
                };
                container.appendChild(btn);
            });
            overlay.style.display = 'flex';
            if(showInput) setTimeout(() => document.getElementById('modalField').focus(), 50);
        }

        function initDaySelector() {
            const container = document.getElementById('mainDaySelector');
            container.innerHTML = weekDays.map(d => `<button class="day-btn" id="btn-${d}" onclick="selectDay('${d}')">${d}</button>`).join('');
            const todayIdx = new Date().getDay();
            selectDay(weekDays[todayIdx === 0 ? 6 : todayIdx - 1]);
        }

        function selectDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            const targetBtn = document.getElementById('btn-' + day);
            if(targetBtn) targetBtn.classList.add('active');
            document.getElementById('addModeBtn').innerText = `Add Prayer for ${day}`;
            showView();
        }

        function showView() {
            editingGroupId = null;
            document.getElementById('prayerInput').value = '';
            document.getElementById('viewSection').style.display = 'block';
            document.getElementById('addSection').style.display = 'none';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('viewModeBtn').classList.add('active');
            renderPrayers();
        }

        function openAddMode(cat) {
            selectedCategory = cat;
            document.getElementById('prayerInput').value = '';
            document.getElementById('viewSection').style.display = 'none';
            document.getElementById('addSection').style.display = 'block';
            document.getElementById('dayPicker').style.display = (cat === 'special') ? 'grid' : 'none';
            document.getElementById('specialManagerArea').style.display = (cat === 'special') ? 'block' : 'none';
            if(cat === 'special') {
                multiSelectedDays = [];
                renderDayPicker();
                renderSpecialManager();
                document.getElementById('addTitle').innerText = "Add Special Prayer";
            } else {
                document.getElementById('addTitle').innerText = (cat === 'everyday') ? "Everyday Prayer" : `${currentDay} Prayer`;
            }
            setTimeout(() => document.getElementById('prayerInput').focus(), 50);
        }

        function renderDayPicker() {
            document.getElementById('dayPicker').innerHTML = weekDays.map(d => `<div class="picker-day ${multiSelectedDays.includes(d) ? 'selected' : ''}" id="pick-${d}" onclick="togglePickerDay('${d}')">${d.substring(0,3)}</div>`).join('');
        }

        function togglePickerDay(day) {
            const idx = multiSelectedDays.indexOf(day);
            if(idx > -1) multiSelectedDays.splice(idx, 1);
            else multiSelectedDays.push(day);
            document.getElementById('pick-'+day).classList.toggle('selected');
        }

        function saveNewPrayer() {
            const text = document.getElementById('prayerInput').value.trim();
            if (!text) return;
            const db = getDB();
            if (selectedCategory === 'special') {
                if (multiSelectedDays.length === 0) return;
                const gId = Date.now();
                multiSelectedDays.forEach(day => {
                    db[day].push({ id: Date.now() + Math.random(), groupId: gId, text, subs: [], isSpecial: true });
                });
            } else if (selectedCategory === 'everyday') {
                db.everyday.push({ id: Date.now(), text, subs: [] });
            } else {
                db[currentDay].push({ id: Date.now(), text, subs: [] });
            }
            saveDB(db);
            showView();
        }

        function addSub(dayKey, id) {
            showModal("Add specific detail:", [
                { text: "Save", bg: 'var(--gold)', color: 'white', action: (val) => {
                    const db = getDB();
                    const prayer = db[dayKey].find(x => x.id === id);
                    if (!prayer) return;
                    if (prayer.isSpecial && prayer.groupId) {
                        setTimeout(() => {
                            showModal("Add to all days?", [
                                { text: "Just today", action: () => {
                                    if(!prayer.subs) prayer.subs = [];
                                    prayer.subs.push({id: Date.now(), text: val});
                                    saveDB(db); renderPrayers();
                                }},
                                { text: "Add to all days", bg: 'var(--gold)', color: 'white', action: () => {
                                    const gId = prayer.groupId;
                                    weekDays.forEach(d => {
                                        const inst = db[d].find(p => p.groupId === gId);
                                        if (inst) {
                                            if(!inst.subs) inst.subs = [];
                                            inst.subs.push({id: Date.now() + Math.random(), text: val});
                                        }
                                    });
                                    saveDB(db); renderPrayers();
                                }},
                                { text: "Cancel", isCancel: true, action: () => {} }
                            ]);
                        }, 300);
                    } else {
                        if(!prayer.subs) prayer.subs = [];
                        prayer.subs.push({id: Date.now(), text: val});
                        saveDB(db); renderPrayers();
                    }
                }},
                { text: "Cancel", isCancel: true, action: () => {} }
            ], true);
        }

        function deletePrayerRequest(dayKey, id, groupId = null) {
            const db = getDB();
            if (groupId) {
                showModal("Delete Special Prayer?", [
                    { text: "Delete from today only", action: () => { 
                        db[dayKey] = db[dayKey].filter(p => p.id !== id);
                        saveDB(db); renderPrayers(); renderSpecialManager();
                    }},
                    { text: "Delete from all days", bg: 'var(--terracotta)', color: 'white', action: () => { 
                        weekDays.forEach(d => { db[d] = db[d].filter(p => p.groupId !== groupId); });
                        saveDB(db); renderPrayers(); renderSpecialManager();
                    }},
                    { text: "Cancel", isCancel: true, action: () => {} }
                ]);
            } else {
                showModal("Delete this prayer?", [
                    { text: "Delete", bg: 'var(--terracotta)', color: 'white', action: () => { 
                        db[dayKey] = db[dayKey].filter(p => p.id !== id);
                        saveDB(db); renderPrayers(); 
                    }},
                    { text: "Cancel", isCancel: true, action: () => {} }
                ]);
            }
        }

        function deleteSub(dk, pi, si) {
            const db = getDB();
            const prayer = db[dk].find(x => x.id === pi);
            if (!prayer) return;
            const subObj = prayer.subs.find(s => s.id === si);
            const subText = subObj ? subObj.text : "";

            if (prayer.isSpecial && prayer.groupId) {
                showModal("Delete point?", [
                    { text: "Today only", action: () => {
                        prayer.subs = prayer.subs.filter(s => s.id !== si);
                        saveDB(db); renderPrayers();
                    }},
                    { text: "All days in group", bg: 'var(--terracotta)', color: 'white', action: () => {
                        const gId = prayer.groupId;
                        weekDays.forEach(d => {
                            const inst = db[d].find(p => p.groupId === gId);
                            if (inst && inst.subs) inst.subs = inst.subs.filter(s => s.text !== subText);
                        });
                        saveDB(db); renderPrayers();
                    }},
                    { text: "Cancel", isCancel: true, action: () => {} }
                ]);
            } else {
                prayer.subs = prayer.subs.filter(s => s.id !== si);
                saveDB(db); renderPrayers();
            }
        }

        function renderPrayers() {
            const db = getDB();
            const list = document.getElementById('prayerList');
            let html = '';
            [{k: 'everyday', l: 'Everyday'}, {k: currentDay, l: currentDay}].forEach(group => {
                (db[group.k] || []).forEach(p => {
                    let subHtml = (p.subs || []).map(s => `<div class="sub-item"><span class="sub-text">â€¢ ${s.text}</span><button class="icon-btn sub-delete" onclick="deleteSub('${group.k}', ${p.id}, ${s.id})">ðŸ—‘</button></div>`).join('');
                    html += `<div class="prayer-item"><div class="prayer-header"><div class="prayer-text">${p.text}</div><div class="prayer-actions"><button class="icon-btn" onclick="addSub('${group.k}', ${p.id})">âž•</button><button class="icon-btn" onclick="deletePrayerRequest('${group.k}', ${p.id}, ${p.groupId})">ðŸ—‘</button></div></div><div style="font-size:0.7rem; color:var(--soft-green); text-transform:uppercase; margin-top:4px;">${group.l} ${p.isSpecial ? '(Special)' : ''}</div>${subHtml ? `<div class="sub-list">${subHtml}</div>` : ''}</div>`;
                });
            });
            list.innerHTML = html || '<p style="text-align:center; padding:30px; color:#999; font-style:italic;">No prayers for this day.</p>';
        }

        function renderSpecialManager() {
            const db = getDB();
            const groups = {};
            weekDays.forEach(d => { db[d].forEach(p => { if(p.isSpecial) groups[p.groupId] = p.text; }); });
            const html = Object.keys(groups).map(gId => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--cream); margin-bottom:5px; border-radius:8px;"><span>${groups[gId]}</span><button class="icon-btn" onclick="deletePrayerRequest('', 0, ${gId})">ðŸ—‘</button></div>`).join('');
            const area = document.getElementById('specialItemsList');
            if(area) area.innerHTML = html || '<p style="font-size:0.8rem; color:#999;">No special prayers yet.</p>';
        }

        function confirmExport() {
            showModal("Export your prayer list to a file?", [
                { text: "Export Now", bg: 'var(--gold)', color: 'white', action: () => exportData() },
                { text: "Cancel", isCancel: true, action: () => {} }
            ]);
        }

        function exportData() {
            const db = getDB();
            const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'prayers_backup.json';
            a.click();
        }

        function importData(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    saveDB(data);
                    showModal("Import successful and synced to cloud!", [{text: "Perfect", action: () => {}}]);
                } catch(err) {
                    showModal("Error: Invalid backup file.", [{text: "OK", action: () => {}}]);
                }
            };
            reader.readAsText(e.target.files[0]);
        }

        function toggleTheme() {
            const target = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('prayerTheme', target);
            document.getElementById('themeBtn').innerText = target === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        const savedThemeInit = localStorage.getItem('prayerTheme') || 'light';
        document.documentElement.setAttribute('data-theme', savedThemeInit);
        initDaySelector();
    </script>
</body>
</html>
